---
# SECURITY: Least-privilege RBAC for StreamSpace controller
# Controller only has access to streamspace namespace, not cluster-wide

apiVersion: v1
kind: ServiceAccount
metadata:
  name: streamspace-controller
  namespace: streamspace
  labels:
    app: streamspace
    component: controller
automountServiceAccountToken: true

---
# Namespace-scoped Role (not ClusterRole) for streamspace resources
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: streamspace-controller
  namespace: streamspace
rules:
  # Manage Sessions and Templates (new API group)
  - apiGroups: [stream.space]
    resources: [sessions, templates]
    verbs: [get, list, watch, create, update, patch, delete]
  - apiGroups: [stream.space]
    resources: [sessions/status, templates/status]
    verbs: [get, update, patch]

  # Legacy CRDs for backwards compatibility (read-only)
  - apiGroups: [workspaces.aiinfra.io]
    resources: [workspacesessions, workspacetemplates]
    verbs: [get, list, watch]

  # Manage session pods (only in streamspace namespace)
  - apiGroups: [""]
    resources: [pods]
    verbs: [get, list, watch, create, update, patch, delete]

  # Manage session services (only in streamspace namespace)
  - apiGroups: [""]
    resources: [services]
    verbs: [get, list, watch, create, update, patch, delete]

  # Manage session deployments (only in streamspace namespace)
  - apiGroups: [apps]
    resources: [deployments]
    verbs: [get, list, watch, create, update, patch, delete]

  # Manage user PVCs (only in streamspace namespace)
  - apiGroups: [""]
    resources: [persistentvolumeclaims]
    verbs: [get, list, watch, create, update, patch]

  # Read-only access to configmaps and secrets
  - apiGroups: [""]
    resources: [configmaps]
    verbs: [get, list, watch]
  - apiGroups: [""]
    resources: [secrets]
    verbs: [get, list, watch]

  # Create events for logging
  - apiGroups: [""]
    resources: [events]
    verbs: [create, patch]

  # Manage ingress for session access (only in streamspace namespace)
  - apiGroups: [networking.k8s.io]
    resources: [ingresses]
    verbs: [get, list, watch, create, update, patch, delete]

  # Read pod logs for debugging
  - apiGroups: [""]
    resources: [pods/log]
    verbs: [get, list]

---
# RoleBinding (namespace-scoped, not cluster-scoped)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: streamspace-controller
  namespace: streamspace
subjects:
  - kind: ServiceAccount
    name: streamspace-controller
    namespace: streamspace
roleRef:
  kind: Role
  name: streamspace-controller
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole for controller to watch Sessions and Templates cluster-wide
# Required because controller-runtime watches resources at cluster scope by default
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: streamspace-controller
rules:
  # Read CRD definitions (needed for controller to understand resource schemas)
  - apiGroups: [apiextensions.k8s.io]
    resources: [customresourcedefinitions]
    verbs: [get, list, watch]

  # Manage Sessions and Templates (cluster-wide for controller watches)
  - apiGroups: [stream.space]
    resources: [sessions, templates]
    verbs: [get, list, watch, create, update, patch, delete]
  - apiGroups: [stream.space]
    resources: [sessions/status, templates/status]
    verbs: [get, update, patch]

  # Leader election requires coordination.k8s.io access
  - apiGroups: [coordination.k8s.io]
    resources: [leases]
    verbs: [get, list, watch, create, update, patch, delete]

---
# ClusterRoleBinding for controller cluster-wide permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: streamspace-controller
subjects:
  - kind: ServiceAccount
    name: streamspace-controller
    namespace: streamspace
roleRef:
  kind: ClusterRole
  name: streamspace-controller
  apiGroup: rbac.authorization.k8s.io

---
# ServiceAccount for StreamSpace API backend
apiVersion: v1
kind: ServiceAccount
metadata:
  name: streamspace-api
  namespace: streamspace
  labels:
    app: streamspace
    component: api
automountServiceAccountToken: true

---
# ClusterRole for API backend (needs cluster-wide node access)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: streamspace-api
rules:
  # Read CRD definitions
  - apiGroups: [apiextensions.k8s.io]
    resources: [customresourcedefinitions]
    verbs: [get, list, watch]

  # Cluster-wide node access (nodes are cluster-scoped resources)
  - apiGroups: [""]
    resources: [nodes]
    verbs: [get, list, watch, update, patch]

  # Manage Sessions and Templates (cluster-wide for multi-namespace support)
  - apiGroups: [stream.space]
    resources: [sessions, templates]
    verbs: [get, list, watch, create, update, patch, delete]
  - apiGroups: [stream.space]
    resources: [sessions/status, templates/status]
    verbs: [get, update, patch]

---
# Role for API backend namespace-scoped resources
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: streamspace-api
  namespace: streamspace
rules:
  # Manage session pods
  - apiGroups: [""]
    resources: [pods]
    verbs: [get, list, watch, create, update, patch, delete]

  # Manage session services and PVCs
  - apiGroups: [""]
    resources: [services, persistentvolumeclaims]
    verbs: [get, list, watch, create, update, patch, delete]

  # Manage session deployments
  - apiGroups: [apps]
    resources: [deployments]
    verbs: [get, list, watch, create, update, patch, delete]

  # Access to configmaps and secrets
  - apiGroups: [""]
    resources: [configmaps, secrets]
    verbs: [get, list, watch]

  # Create events for logging
  - apiGroups: [""]
    resources: [events]
    verbs: [create, patch]

  # Manage ingress for session access
  - apiGroups: [networking.k8s.io]
    resources: [ingresses]
    verbs: [get, list, watch, create, update, patch, delete]

  # Read pod logs for debugging
  - apiGroups: [""]
    resources: [pods/log]
    verbs: [get, list]

---
# ClusterRoleBinding for API backend cluster-wide permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: streamspace-api
subjects:
  - kind: ServiceAccount
    name: streamspace-api
    namespace: streamspace
roleRef:
  kind: ClusterRole
  name: streamspace-api
  apiGroup: rbac.authorization.k8s.io

---
# RoleBinding for API backend namespace-scoped permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: streamspace-api
  namespace: streamspace
subjects:
  - kind: ServiceAccount
    name: streamspace-api
    namespace: streamspace
roleRef:
  kind: Role
  name: streamspace-api
  apiGroup: rbac.authorization.k8s.io
