apiVersion: apps/v1
kind: Deployment
metadata:
  name: streamspace-ui
  namespace: streamspace
  labels:
    app: streamspace
    component: ui
spec:
  replicas: 2
  selector:
    matchLabels:
      app: streamspace
      component: ui
  template:
    metadata:
      labels:
        app: streamspace
        component: ui
    spec:
      containers:
      - name: ui
        image: your-registry/streamspace-ui:v0.2.0
        imagePullPolicy: IfNotPresent
        ports:
          - name: http
            containerPort: 80
            protocol: TCP

        # No environment variables needed - API URL is configured at build time
        # via VITE_API_URL in the Dockerfile or at runtime via nginx config

        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 200m

        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 20
          timeoutSeconds: 3
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3

        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 101  # nginx user
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true

        volumeMounts:
          - name: nginx-cache
            mountPath: /var/cache/nginx
          - name: nginx-run
            mountPath: /var/run

      volumes:
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-run
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: streamspace-ui
  namespace: streamspace
  labels:
    app: streamspace
    component: ui
spec:
  type: ClusterIP
  selector:
    app: streamspace
    component: ui
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: streamspace
  namespace: streamspace
  labels:
    app: streamspace
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod  # Optional: for TLS
    traefik.ingress.kubernetes.io/router.entrypoints: websecure  # For Traefik
    nginx.ingress.kubernetes.io/ssl-redirect: "true"  # For Nginx
spec:
  ingressClassName: traefik  # or nginx
  rules:
    - host: streamspace.local  # TODO: Update with your domain
      http:
        paths:
          # UI
          - path: /
            pathType: Prefix
            backend:
              service:
                name: streamspace-ui
                port:
                  number: 80

          # API endpoints
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: streamspace-api
                port:
                  number: 8000

          # Health endpoints
          - path: /health
            pathType: Exact
            backend:
              service:
                name: streamspace-api
                port:
                  number: 8000

          - path: /version
            pathType: Exact
            backend:
              service:
                name: streamspace-api
                port:
                  number: 8000

  # TLS configuration (optional)
  # tls:
  #   - hosts:
  #       - streamspace.local
  #     secretName: streamspace-tls
